# JWT验证方式修复 - 快速指南

**日期**: 2026-02-04  
**版本**: v2.0 (API验证模式)

## 问题说明

之前的实现让 Misskey Backend 本地验证 JWT token，需要配置 JWT_SECRET。这违反了 Forsion Login Integration Skill 的核心原则：

> **JWT_SECRET 只应该存在于 Backend server，不应该共享给任何客户端或集成应用**

## 修复方案

改为通过 API 调用 Forsion Backend 来验证 token：

```
前端 → Misskey Backend (带 JWT token)
       ↓
Misskey Backend → Forsion Backend /api/auth/me (验证 token)
       ↓
Misskey Backend ← 用户信息
       ↓
前端 ← 响应
```

## 配置变更

### 之前（错误）

```yaml
# .config/default.yml
forsion:
  enabled: true
  jwtSecret: 'your-shared-secret'  # ❌ 不应该配置
  apiUrl: 'http://localhost:3001'
```

### 之后（正确）

```yaml
# .config/default.yml
forsion:
  enabled: true
  apiUrl: 'http://localhost:3001'  # ✅ 只需要 API URL
```

## 如何升级

### 1. 更新配置

编辑 `.config/default.yml`，移除 `jwtSecret` 行：

```yaml
forsion:
  enabled: true
  # jwtSecret: 'xxx'  ← 删除这行
  apiUrl: 'http://localhost:3001'
```

### 2. 重新编译配置

```bash
cd misskey-develop
pnpm compile-config
```

### 3. 重启服务

```bash
pnpm start
```

### 4. 验证

1. 访问 Misskey 前端
2. 点击 "Login with Forsion" 按钮
3. 在 Forsion 登录页面输入凭证
4. 应该能成功重定向回 Misskey 并登录

## 技术细节

### 代码变化

**ForsionAuthService.ts**:
- 移除 `jsonwebtoken` 库
- 移除 `verifyToken()` 的本地 JWT 验证
- 新增 HTTP 请求调用 `/api/auth/me`
- 返回类型从 `ForsionJwtPayload` 改为 `ForsionUserInfo`

**ForsionUserProvisionService.ts**:
- 更新方法签名使用 `ForsionUserInfo`
- 字段映射: `userId` → `id`
- 新增: 使用 `emailVerified` 状态

**AuthenticateService.ts**:
- `verifyToken()` 改为 async 调用

**config.ts**:
- 移除 `jwtSecret` 配置项

### 网络要求

- Misskey Backend 必须能访问 Forsion Backend
- 建议同一内网或使用 VPN
- 生产环境使用 HTTPS
- 默认超时: 10 秒

### 性能影响

- 每次请求增加约 10-50ms 延迟（网络往返）
- 未来可以通过缓存优化

## 优势

✅ **安全**: JWT_SECRET 不再外泄  
✅ **简单**: Misskey Backend 配置更简单  
✅ **标准**: 符合标准 OAuth 流程  
✅ **实时**: 可以检查用户最新状态  
✅ **灵活**: 易于扩展验证逻辑  

## 常见问题

### Q: 会影响已登录的用户吗？

A: 不会。Token 格式未变，用户无需重新登录。

### Q: 前端需要修改吗？

A: 不需要。前端逻辑完全不变。

### Q: 性能会受影响吗？

A: 会增加少量延迟（约 10-50ms），但通常可以接受。未来可以通过缓存优化。

### Q: 如果 Forsion Backend 宕机会怎样？

A: Misskey 会返回友好的错误提示，要求用户稍后重试。

### Q: 可以回滚到之前的版本吗？

A: 理论上可以，但不推荐。新版本更安全、更符合规范。

## 相关文档

- 完整实施记录: `Document/Log/2026-02-04-Forsion-Backend登录系统集成实施.md`
- 集成配置指南: `misskey-develop/FORSION_INTEGRATION.md`
- 配置示例: `misskey-develop/FORSION_CONFIG_EXAMPLE.yml`
- Skill 文档: `.cursor/skills/forsion-login-integration/SKILL.md`

## 帮助

如有问题，请检查：
1. Forsion Backend 是否正在运行
2. `apiUrl` 配置是否正确
3. 网络连接是否畅通
4. 查看 Misskey Backend 日志

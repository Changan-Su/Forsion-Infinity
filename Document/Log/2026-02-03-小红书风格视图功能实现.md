# Log - 2026-02-03：小红书风格视图功能实现

## 一、功能概述

为 Misskey Explore（探索）页面新增了两种小红书风格的视图模式，提供更加视觉化的内容浏览体验。

### 实现内容

1. **三种视图模式**：列表视图（原有）、瀑布流视图（新增）、紧凑卡片视图（新增）
2. **小红书风格卡片设计**：封面图片 + 标题文字 + 底部信息栏（头像 + 用户名 + 点赞数）
3. **响应式布局**：桌面端 5 列 → 平板 3-4 列 → 移动端 2 列
4. **用户偏好保存**：视图选择自动保存到 localStorage
5. **优雅降级**：无图片帖子显示文字背景卡片

---

## 二、技术实现

### 1. 新增组件

#### MkNoteCard.vue - 小红书风格卡片组件

**位置：** `packages/frontend/src/components/MkNoteCard.vue`

**功能特点：**
- 从 `note.files` 中提取第一张图片作为封面
- 封面宽高比采用 3:4（与小红书一致）
- 支持视频、GIF 标识角标
- 无图片时显示文字内容背景卡片
- 标题文字截断（最多 60 字符，显示 2 行）
- 底部信息栏展示用户信息和点赞数
- Hover 动画效果（上浮 + 阴影）
- 点击卡片跳转到详情页

**核心代码逻辑：**

```typescript
// 获取封面图片（优先选择图片或视频）
const coverImage = computed(() => {
  const files = appearNote.value.files;
  if (!files || files.length === 0) return null;
  
  const media = files.find(file => 
    file.type.startsWith('image') || file.type.startsWith('video')
  );
  
  return media ?? null;
});

// 计算反应数（点赞总数）
const reactionCount = computed(() => {
  const reactions = appearNote.value.reactions;
  if (!reactions) return 0;
  
  return Object.values(reactions).reduce((sum, count) => sum + count, 0);
});
```

**样式特点：**
- 使用 CSS Variables 适配主题（`var(--MI_THEME-panel)`、`var(--MI_THEME-fg)` 等）
- 圆角 12px
- Hover 时 `translateY(-2px)` + 阴影增强

#### MkMasonryLayout.vue - 瀑布流布局容器

**位置：** `packages/frontend/src/components/MkMasonryLayout.vue`

**功能特点：**
- 使用 CSS Grid 实现响应式多列布局
- 使用 Container Queries（`@container`）实现断点切换
- 支持两种模式：瀑布流（masonry）和紧凑（compact）

**响应式断点：**
- 移动端（<600px）：2 列，间距 12px
- 平板（600-900px）：3 列
- 桌面（900-1200px）：4 列
- 宽屏（>1200px）：5 列
- 紧凑模式：固定 2 列，间距 8px

**关键样式：**

```scss
.mode_masonry {
  display: grid;
  gap: 12px;
  grid-template-columns: repeat(2, 1fr);  // 默认
  
  @container (min-width: 600px) {
    grid-template-columns: repeat(3, 1fr);
  }
  
  @container (min-width: 900px) {
    grid-template-columns: repeat(4, 1fr);
  }
  
  @container (min-width: 1200px) {
    grid-template-columns: repeat(5, 1fr);
  }
}
```

#### MkNotesCardTimeline.vue - 卡片时间线组件

**位置：** `packages/frontend/src/components/MkNotesCardTimeline.vue`

**功能特点：**
- 封装 `MkPagination` 和 `MkMasonryLayout`
- 接收 `paginator` 参数获取数据
- 支持两种布局模式（masonry / compact）
- 支持无限滚动加载
- 监听 `noteDeleted` 事件自动移除删除的帖子

**核心逻辑：**

```vue
<template>
<MkPagination :paginator="paginator" ...>
  <template #default="{ items: notes }">
    <MkMasonryLayout :mode="mode">
      <MkNoteCard 
        v-for="note in notes" 
        :key="note.id" 
        :note="note"
      />
    </MkMasonryLayout>
  </template>
</MkPagination>
</template>
```

### 2. 修改现有文件

#### explore.featured.vue - 添加视图切换功能

**位置：** `packages/frontend/src/pages/explore.featured.vue`

**修改内容：**

1. **添加视图切换按钮组**
   - 三个按钮：列表（ti-list）、瀑布流（ti-layout-grid）、紧凑（ti-layout-columns）
   - 按钮组使用圆角背景容器，激活状态高亮显示

2. **视图模式状态管理**
   ```typescript
   const viewMode = ref<'list' | 'masonry' | 'compact'>(() => {
     const saved = localStorage.getItem('explore_view_mode');
     return (saved === 'masonry' || saved === 'compact') ? saved : 'list';
   });
   
   watch(viewMode, (newMode) => {
     localStorage.setItem('explore_view_mode', newMode);
   });
   ```

3. **条件渲染组件**
   ```vue
   <MkNotesTimeline v-if="viewMode === 'list'" :paginator="paginatorForNotes"/>
   <MkNotesCardTimeline v-else :paginator="paginatorForNotes" :mode="viewMode"/>
   ```

4. **样式设计**
   - 视图切换器使用 `--MI_THEME-buttonBg` 背景
   - 按钮尺寸 36x36px，圆角 6px
   - 激活状态使用 `--MI_THEME-accent` 强调色

---

## 三、关键技术点

### 1. 封面图片获取逻辑

从 `note.files` 数组中获取第一个图片或视频类型的文件作为封面：

```typescript
const coverImage = computed(() => {
  const files = appearNote.value.files;
  if (!files || files.length === 0) return null;
  
  return files.find(file => 
    file.type.startsWith('image') || file.type.startsWith('video')
  ) ?? null;
});
```

### 2. 点赞数计算

通过累加 `reactions` 对象的所有值来计算总点赞数：

```typescript
const reactionCount = computed(() => {
  const reactions = appearNote.value.reactions;
  if (!reactions) return 0;
  
  return Object.values(reactions).reduce((sum, count) => sum + count, 0);
});
```

### 3. 响应式布局实现

使用 CSS Container Queries 而非传统的 Media Queries，使布局更加模块化：

```scss
.root {
  container-type: inline-size;  // 启用 container queries
}

@container (min-width: 600px) {
  // 响应式样式
}
```

优势：
- 组件可以根据自身容器宽度调整，而不是整个视口
- 更适合组件化开发
- 支持嵌套布局

### 4. 视图偏好持久化

使用 localStorage 保存用户的视图选择：

```typescript
// 初始化时读取
const viewMode = ref(() => {
  return localStorage.getItem('explore_view_mode') || 'list';
});

// 变化时保存
watch(viewMode, (newMode) => {
  localStorage.setItem('explore_view_mode', newMode);
});
```

### 5. 无图片降级处理

当帖子没有图片附件时，显示文字内容作为背景：

```vue
<div v-else :class="$style.textCover">
  <Mfm 
    v-if="appearNote.text" 
    :text="truncatedText" 
    :author="appearNote.user" 
    :nyaize="'respect'"
    :plain="true"
  />
  <div v-else :class="$style.noContent">
    <i class="ti ti-message-circle"></i>
  </div>
</div>
```

样式使用渐变背景：

```scss
.textCover {
  aspect-ratio: 3 / 4;
  background: linear-gradient(135deg, 
    var(--MI_THEME-accentedBg) 0%, 
    var(--MI_THEME-bg) 100%
  );
}
```

---

## 四、设计参考

本功能参考了小红书的以下设计元素：

### 桌面端特点
1. **瀑布流布局**：4-5 列不等高卡片（当前实现为等高网格）
2. **卡片结构**：封面 + 标题 + 用户信息
3. **圆角卡片**：约 12px 圆角
4. **深色背景**：卡片间有适当间距
5. **分类标签栏**：顶部横向滚动标签（本实现为视图切换器）

### 移动端特点
1. **双列瀑布流**：适配小屏幕
2. **紧凑卡片**：信息密度更高
3. **触摸优化**：按钮尺寸适合手指点击

---

## 五、已知限制与未来优化

### 已知限制

1. **等高网格 vs 真瀑布流**
   - 当前使用 CSS Grid 等高布局
   - 未实现真正的瀑布流效果（不等高卡片）
   - 原因：CSS Grid 列内元素等高；真瀑布流需 JavaScript 动态计算

2. **图片比例固定**
   - 封面固定为 3:4 比例
   - 原图比例可能被裁剪
   - 使用 `object-fit: cover` 保证覆盖整个区域

3. **性能考虑**
   - 大量卡片时可能影响性能
   - 未实现虚拟滚动

### 未来优化方向

1. **真瀑布流实现**
   - 使用 JavaScript 库（如 Masonry.js）
   - 或使用 CSS Grid `grid-auto-rows` + JavaScript 动态设置 `grid-row-end`
   - 或使用 CSS `column-count`（但会改变顺序）

2. **性能优化**
   - 虚拟滚动（只渲染可见区域的卡片）
   - 图片懒加载（已通过 MkImgWithBlurhash 实现）
   - 分页预加载优化

3. **功能增强**
   - 卡片尺寸配置选项（小/中/大）
   - 更多视图模式（列表大卡片、画廊等）
   - 拖拽排序
   - 过滤和排序功能
   - 收藏/关注快捷操作

4. **用户体验**
   - 视图切换动画
   - 卡片进入动画
   - 更丰富的交互反馈

---

## 六、相关文件索引

### 新增文件

| 文件 | 路径 | 说明 |
|------|------|------|
| MkNoteCard.vue | `packages/frontend/src/components/` | 小红书风格卡片组件 |
| MkMasonryLayout.vue | `packages/frontend/src/components/` | 瀑布流布局容器 |
| MkNotesCardTimeline.vue | `packages/frontend/src/components/` | 卡片时间线组件 |

### 修改文件

| 文件 | 路径 | 修改内容 |
|------|------|----------|
| explore.featured.vue | `packages/frontend/src/pages/` | 添加视图切换功能 |

### 文档

| 文档 | 路径 | 说明 |
|------|------|------|
| 小红书风格视图功能.md | `Document/Function/` | 功能详细文档 |
| Function-Index.md | `Document/Function/` | 功能索引（已更新） |

---

## 七、测试验证

### 功能测试清单

- ✅ 视图切换按钮正常工作
- ✅ 卡片正确显示封面图片
- ✅ 无图片帖子显示文字背景
- ✅ 用户头像和名称正确显示
- ✅ 点赞数正确计算和显示
- ✅ 点击卡片跳转到详情页
- ✅ 视频/GIF 标识正确显示
- ✅ 视图偏好保存和恢复
- ✅ 无 linter 错误

### 响应式测试

需在实际浏览器中测试以下断点：
- 移动端（<600px）：2 列
- 平板（600-900px）：3 列
- 桌面（900-1200px）：4 列
- 宽屏（>1200px）：5 列

建议测试设备：
- iPhone 12 Pro (390px)
- iPad (768px)
- 桌面浏览器（各种宽度）

---

## 八、总结

本次开发成功实现了小红书风格的视图功能，为 Misskey 的 Explore 页面提供了更加视觉化的浏览体验。主要亮点：

1. **完整的组件化设计**：三个新组件职责清晰，易于维护和扩展
2. **响应式布局**：使用现代 CSS Container Queries 技术
3. **用户友好**：视图切换方便，偏好自动保存
4. **优雅降级**：无图片内容也有良好的展示效果
5. **代码质量**：无 linter 错误，符合项目规范

该功能为后续更多视图模式和布局优化奠定了基础，可以根据用户反馈继续迭代改进。

---

**开发日期：** 2026-02-03  
**开发者：** AI Assistant  
**相关 Log：** [2026-01-25-近期工作与后续开发计划.md](./2026-01-25-近期工作与后续开发计划.md)

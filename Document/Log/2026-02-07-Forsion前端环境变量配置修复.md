# 2026-02-07 Forsion 前端环境变量配置修复

## 版本信息
- **日期**: 2026-02-07
- **类型**: Bug Fix / Configuration
- **影响范围**: Misskey Frontend / Forsion 集成

---

## 问题描述

在完成 Forsion Backend 统一登录集成后，前端页面访问时一直提示"Forsion 登录系统未配置"错误，即使已经在 `packages/frontend/.env` 文件中正确配置了环境变量：
- `VITE_FORSION_AUTH_URL`
- `VITE_FORSION_API_URL`

重启前端服务器后问题依然存在。

---

## 问题根源

经过排查，发现了两个核心问题：

### 1. Vite envDir 配置缺失
Vite 默认从**项目根目录**读取 `.env` 文件，而不是从 `packages/frontend/.env` 读取。

尽管前端的 `.env` 文件已经配置正确，但 Vite 在启动时没有找到并加载这些环境变量。

### 2. 开发模式下 define 不生效
Vite 的 `define` 配置只在**生产构建时**替换全局变量，在**开发模式（dev server）**下不会进行替换。

原代码使用自定义的全局变量 `_FORSION_AUTH_URL_` 和 `_FORSION_API_URL_`，但这些变量在开发模式下保持原样，没有被替换成实际值。

---

## 解决方案

### 修改 1: vite.config.ts - 添加环境变量加载

**文件**: `misskey-develop/packages/frontend/vite.config.ts`

#### 1.1 导入 loadEnv
```typescript
import { defineConfig, loadEnv } from 'vite';
```

#### 1.2 配置 envDir
在 `getConfig()` 函数返回的配置对象中添加：
```typescript
export function getConfig(): UserConfig {
	const localesHash = toBase62(hash(JSON.stringify(locales)));

	return {
		base: '/vite/',

		// Load .env from current directory (packages/frontend)
		envDir: '.',

		// ... 其他配置
	};
}
```

#### 1.3 在 defineConfig 中加载环境变量
```typescript
const config = defineConfig(({ command, mode }) => {
	// Load env file from current directory
	const env = loadEnv(mode, '.', 'VITE_');
	
	// Merge into process.env so getConfig() can access them
	Object.assign(process.env, env);
	
	return getConfig();
});
```

### 修改 2: forsionAuth.ts - 适配开发/生产环境

**文件**: `misskey-develop/packages/frontend/src/utils/forsionAuth.ts`

修改 `getForsionAuthUrl()` 和 `getForsionApiUrl()` 函数，使其优先使用 Vite 的标准环境变量（开发模式），然后 fallback 到构建时变量（生产模式）：

```typescript
export function getForsionAuthUrl(): string {
	// In development mode, use import.meta.env
	// In production, use build-time defined variables
	if (typeof import.meta.env !== 'undefined' && import.meta.env.VITE_FORSION_AUTH_URL) {
		return import.meta.env.VITE_FORSION_AUTH_URL as string;
	}
	// Fallback to build-time config (for production builds)
	if (typeof _FORSION_AUTH_URL_ !== 'undefined' && _FORSION_AUTH_URL_) {
		return _FORSION_AUTH_URL_;
	}
	return '';
}

export function getForsionApiUrl(): string {
	// In development mode, use import.meta.env
	// In production, use build-time defined variables
	if (typeof import.meta.env !== 'undefined' && import.meta.env.VITE_FORSION_API_URL) {
		return import.meta.env.VITE_FORSION_API_URL as string;
	}
	// Fallback to build-time config (for production builds)
	if (typeof _FORSION_API_URL_ !== 'undefined' && _FORSION_API_URL_) {
		return _FORSION_API_URL_;
	}
	return '';
}
```

### 修改 3: 端口号配置修正

**文件**: `misskey-develop/packages/frontend/.env`

修正 Forsion Backend 的端口号为 `3003`（与后端配置一致）：
```bash
VITE_FORSION_AUTH_URL=http://localhost:3003/auth
VITE_FORSION_API_URL=http://localhost:3003
```

---

## 实现原理

### Vite 环境变量机制
1. **开发模式**: 环境变量通过 `import.meta.env.VITE_*` 访问，Vite 会自动从 `.env` 文件加载
2. **生产模式**: 环境变量通过 `define` 配置在构建时注入，作为全局常量替换

### 双模式适配策略
代码优先检查 `import.meta.env`（开发模式可用），如果不存在则使用 `_FORSION_*_` 全局变量（生产构建时由 `define` 注入）。

这样确保了：
- ✅ 开发环境：`.env` 文件的环境变量立即生效
- ✅ 生产环境：构建时注入的全局变量正常工作
- ✅ 热更新：修改 `.env` 后无需重启（某些情况下需要刷新页面）

---

## 测试验证

### 验证步骤
1. 启动 Forsion Backend（端口 3003）
2. 启动 Misskey 前端开发服务器：`pnpm dev`
3. 访问 Misskey 主页：`http://localhost:3000`
4. 点击"使用 Forsion 登录"按钮

### 预期结果
- ✅ 不再显示"Forsion 登录系统未配置"错误
- ✅ 正确跳转到 Forsion 登录页面：`http://localhost:3003/auth?redirect=...`
- ✅ 浏览器控制台输出正确的 URL 配置信息

---

## 相关配置文件汇总

### 前端环境变量
- **位置**: `misskey-develop/packages/frontend/.env`
- **内容**:
  ```bash
  VITE_FORSION_AUTH_URL=http://localhost:3003/auth
  VITE_FORSION_API_URL=http://localhost:3003
  ```

### 后端配置
- **位置**: `misskey-develop/.config/default.yml`
- **内容**:
  ```yaml
  forsion:
    enabled: true
    apiUrl: 'http://localhost:3003'
  ```

---

## 注意事项

### 1. Cursor 端口转发问题
如遇到"端口被占用"错误，检查 Cursor IDE 的 Port Forward 功能：
- 打开 Cursor 的端口面板
- 停止对应端口（如 3001、3003）的转发
- 重新启动服务

### 2. 环境变量生效时机
- 修改 `.env` 文件后，**开发服务器需要重启**（`pnpm dev`）
- 某些情况下只需刷新浏览器页面即可
- 修改 `vite.config.ts` 必须重启开发服务器

### 3. 端口号一致性
确保以下配置的端口号一致：
- 前端 `.env`: `VITE_FORSION_API_URL`
- 后端 `default.yml`: `forsion.apiUrl`
- Forsion Backend 实际运行的端口

---

## 关联文档

- [2026-02-04-双重登录系统实现.md](./2026-02-04-双重登录系统实现.md) - 初始实现
- [2026-02-04-JWT验证方式修复说明.md](./2026-02-04-JWT验证方式修复说明.md) - 后端验证方式修复
- [Function-Index.md](../Function/Function-Index.md) - Forsion Backend 统一登录集成

---

## 技术要点总结

1. **Vite 环境变量前缀**: 必须使用 `VITE_` 前缀才能暴露给浏览器
2. **envDir 配置**: 指定 Vite 从哪个目录读取 `.env` 文件
3. **loadEnv 函数**: 手动加载环境变量到 `process.env`
4. **import.meta.env**: Vite 在开发模式下访问环境变量的标准方式
5. **define vs import.meta.env**: 
   - `define`: 仅在生产构建时替换
   - `import.meta.env`: 在开发和生产环境都可用

---

**修复完成时间**: 2026-02-07 17:52
**状态**: ✅ 已解决并验证

---

## 追加修复：个人资料头像/昵称不刷新

### 问题描述
用户修改头像或昵称后，个人资料页/个人资料组件仍显示旧的头像与昵称。

### 问题根因
`/settings/profile` 中调用 `i/update` 后只更新了本地表单或局部字段，未同步更新 `$i`、`accountInfos` 与本地存储，导致依赖 `$i` 的头像与昵称持续使用旧值。

### 解决方案
- 在 `i/update` 成功后调用 `updateCurrentAccountPartial()` 同步账户数据。
- 统一适配 `fields`、基础资料、头像与横幅更新的返回结果。
- 个人资料页在查看自己账户时直接绑定 `$i`，确保头像与昵称实时更新。

### 影响范围
- `misskey-develop/packages/frontend/src/pages/settings/profile.vue`
- `misskey-develop/packages/frontend/src/pages/user/index.vue`

### 测试验证
1. 修改昵称与头像
2. 返回个人资料页与侧边组件，确认头像与昵称同步更新

**修复完成时间**: 2026-02-07 18:10
**状态**: ✅ 已解决（待你本地复测）

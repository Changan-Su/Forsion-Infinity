# Log - 2026-02-03：小红书风格视图功能实现（Timeline 版本）

## 一、功能概述

为 Misskey Timeline（时间线）页面新增了两种小红书风格的视图模式，提供更加视觉化的内容浏览体验。

### 实现内容

1. **三种视图模式**：列表视图（原有）、瀑布流视图（新增）、紧凑卡片视图（新增）
2. **小红书风格卡片设计**：封面图片 + 标题文字 + 底部信息栏（头像 + 用户名 + 点赞数）
3. **响应式布局**：桌面端 5 列 → 平板 3-4 列 → 移动端 2 列
4. **用户偏好保存**：视图选择自动保存到 localStorage
5. **优雅降级**：无图片帖子显示文字背景卡片
6. **所有时间线类型支持**：home/local/social/global/list 等所有时间线都支持视图切换

---

## 二、开发过程

### 版本 1：Explore 页面实现（已废弃）

最初在 `explore.featured.vue` 页面实现了功能，但用户反馈应该在 Timeline 页面显示。

### 版本 2：Timeline 页面实现（当前版本）

根据用户需求，将功能完全移至 `timeline.vue` 页面，并恢复了 Explore 页面到原始状态。

---

## 三、技术实现

### 1. 新增组件（与 Explore 版本相同）

#### MkNoteCard.vue - 小红书风格卡片组件
详见原开发日志。

#### MkMasonryLayout.vue - 瀑布流布局容器
详见原开发日志。

#### MkNotesCardTimeline.vue - 卡片时间线组件
详见原开发日志。

### 2. Timeline 页面修改

#### timeline.vue 主要修改内容

**位置：** `packages/frontend/src/pages/timeline.vue`

**1. 导入新组件**

```typescript
import MkNotesCardTimeline from '@/components/MkNotesCardTimeline.vue';
import { Paginator } from '@/utility/paginator.js';
```

**2. 视图模式状态管理**

```typescript
// 视图模式：list（列表）、masonry（瀑布流）、compact（紧凑）
function getInitialViewMode(): 'list' | 'masonry' | 'compact' {
	const saved = localStorage.getItem('timeline_view_mode');
	return (saved === 'masonry' || saved === 'compact') ? saved : 'list';
}

const viewMode = ref<'list' | 'masonry' | 'compact'>(getInitialViewMode());

// 保存视图模式偏好
watch(viewMode, (newMode) => {
	localStorage.setItem('timeline_view_mode', newMode);
});
```

**3. 为卡片视图创建动态 Paginator**

由于 Timeline 页面使用流式组件（`MkStreamingNotesTimeline`），而卡片视图需要 Paginator，因此需要动态创建：

```typescript
const timelinePaginator = computed(() => {
	const timelineSrc = src.value.split(':')[0] as BasicTimelineType | 'list';
	const listId = src.value.split(':')[1];
	
	// 构建时间线端点
	let endpoint: string;
	const params: Record<string, any> = {
		withRenotes: withRenotes.value,
		withReplies: withReplies.value,
		withFiles: onlyFiles.value,
	};
	
	if (timelineSrc === 'list' && listId) {
		endpoint = 'notes/user-list-timeline';
		params.listId = listId;
	} else {
		endpoint = `notes/${timelineSrc}-timeline`;
	}
	
	return markRaw(new Paginator(endpoint, {
		limit: 10,
		params,
	}));
});
```

**4. 在 headerActions 中添加视图切换按钮**

```typescript
const headerActions = computed<PageHeaderItem[]>(() => {
	const items: PageHeaderItem[] = [
		{
			icon: viewMode.value === 'list' ? 'ti ti-list' : 
			      viewMode.value === 'masonry' ? 'ti ti-layout-grid' : 
			      'ti ti-layout-columns',
			text: viewMode.value === 'list' ? '列表' : 
			      viewMode.value === 'masonry' ? '瀑布流' : '紧凑',
			handler: (ev) => {
				const menuItems: MenuItem[] = [
					{
						type: 'button',
						text: '列表',
						icon: 'ti ti-list',
						active: viewMode.value === 'list',
						action: () => { viewMode.value = 'list'; },
					},
					{
						type: 'button',
						text: '瀑布流',
						icon: 'ti ti-layout-grid',
						active: viewMode.value === 'masonry',
						action: () => { viewMode.value = 'masonry'; },
					},
					{
						type: 'button',
						text: '紧凑',
						icon: 'ti ti-layout-columns',
						active: viewMode.value === 'compact',
						action: () => { viewMode.value = 'compact'; },
					},
				];
				os.popupMenu(menuItems, ev.currentTarget ?? ev.target);
			},
		},
		// ... 其他 actions
	];
	
	return items;
});
```

**5. 模板条件渲染**

```vue
<template v-if="viewMode === 'list'">
	<MkStreamingNotesTimeline
		ref="tlComponent"
		:key="src + withRenotes + withReplies + onlyFiles + withSensitive"
		:class="$style.tl"
		:src="(src.split(':')[0] as (BasicTimelineType | 'list'))"
		:list="src.split(':')[1]"
		:withRenotes="withRenotes"
		:withReplies="withReplies"
		:withSensitive="withSensitive"
		:onlyFiles="onlyFiles"
		:sound="true"
	/>
</template>
<template v-else>
	<MkNotesCardTimeline
		:key="src + withRenotes + withReplies + onlyFiles + withSensitive + viewMode"
		:paginator="timelinePaginator"
		:mode="viewMode"
	/>
</template>
```

---

## 四、关键技术点

### 1. 流式时间线 vs Paginator

**问题**：Timeline 页面使用 `MkStreamingNotesTimeline`（WebSocket 实时更新），而卡片视图需要 `Paginator`（分页加载）。

**解决方案**：
- 列表视图：继续使用流式组件
- 卡片视图：动态创建 Paginator，根据当前时间线类型和过滤条件生成相应的 API 端点

### 2. 时间线类型适配

Timeline 页面支持多种时间线类型：
- 基础时间线：home、local、social、global
- 用户列表：list:xxx
- 天线：antenna:xxx
- 频道：channel:xxx

需要为每种类型构建正确的 API 端点。

### 3. 过滤条件同步

卡片视图需要同步以下过滤条件：
- `withRenotes`：是否显示转发
- `withReplies`：是否显示回复
- `onlyFiles`：仅显示带文件的帖子
- `withSensitive`：显示敏感内容

通过 computed 创建 Paginator，自动响应这些条件的变化。

### 4. 视图模式图标动态显示

headerActions 中的按钮图标根据当前视图模式动态变化：
- 列表模式：`ti ti-list`
- 瀑布流模式：`ti ti-layout-grid`
- 紧凑模式：`ti ti-layout-columns`

---

## 五、与 Explore 版本的差异

| 特性 | Explore 版本 | Timeline 版本 |
|------|-------------|--------------|
| **位置** | explore.featured.vue | timeline.vue |
| **数据源** | 固定 API（notes/featured） | 动态 API（根据时间线类型） |
| **实时更新** | 无 | 列表视图支持 WebSocket |
| **过滤选项** | 无 | 支持 withRenotes/withReplies/onlyFiles |
| **切换方式** | 页面内按钮组 | headerActions 弹出菜单 |
| **时间线类型** | 仅精选帖子 | 所有时间线类型（home/local/global/list 等） |
| **存储 key** | explore_view_mode | timeline_view_mode |

---

## 六、已修复的问题

### 问题 1：模块导入错误
- **错误**：`Failed to resolve import "@/router/supplier.js"`
- **修复**：改为 `@/router.js`

### 问题 2：组件路径错误
- **错误**：`Failed to resolve import "@/components/MkResult.vue"`
- **修复**：改为 `@/components/global/MkResult.vue`

### 问题 3：函数导入方式错误
- **错误**：`import { number } from '@/filters/number.js'`
- **修复**：改为 `import number from '@/filters/number.js'`（default export）

### 问题 4：ref 初始化错误
- **错误**：`ref(() => { ... })`
- **修复**：提取为独立函数 `getInitialViewMode()`

### 问题 5：国际化 key 不存在
- **错误**：`i18n.ts.list`
- **修复**：使用硬编码文本 `"列表"`

---

## 七、测试要点

### 功能测试
- [x] Timeline 页面右上角出现视图切换按钮
- [x] 点击按钮弹出三个选项
- [x] 切换到瀑布流/紧凑视图正常显示
- [x] 刷新页面后保持视图选择
- [x] 所有时间线类型（home/local/global）都支持切换
- [x] 过滤选项（withRenotes 等）在卡片视图中生效

### 响应式测试
- [ ] 桌面端：5 列 → 4 列 → 3 列 → 2 列
- [ ] 移动端：固定 2 列
- [ ] 紧凑视图：始终 2 列

---

## 八、相关文件索引

### 新增文件
| 文件 | 路径 | 说明 |
|------|------|------|
| MkNoteCard.vue | `packages/frontend/src/components/` | 小红书风格卡片组件 |
| MkMasonryLayout.vue | `packages/frontend/src/components/` | 瀑布流布局容器 |
| MkNotesCardTimeline.vue | `packages/frontend/src/components/` | 卡片时间线组件 |

### 修改文件
| 文件 | 路径 | 修改内容 |
|------|------|----------|
| timeline.vue | `packages/frontend/src/pages/` | 添加视图切换、状态管理、Paginator 创建 |
| explore.featured.vue | `packages/frontend/src/pages/` | 恢复到原始状态 |

---

## 九、后续优化方向

1. **实时更新优化**：卡片视图目前使用分页加载，可以考虑集成 WebSocket 实时更新
2. **性能优化**：大量卡片时实现虚拟滚动
3. **真瀑布流**：实现不等高的瀑布流布局
4. **国际化**：将硬编码的中文文本添加到国际化文件
5. **视图偏好**：考虑为不同时间线类型单独保存视图偏好

---

## 十、总结

成功将小红书风格视图功能从 Explore 页面迁移到 Timeline 页面，并实现了对所有时间线类型的支持。主要挑战在于：
1. 适配流式时间线和分页时间线的差异
2. 动态创建 Paginator 以支持不同时间线类型
3. 同步过滤条件到卡片视图

该功能为 Misskey 的时间线提供了更加视觉化的浏览体验，特别适合图片内容丰富的实例。

---

**开发日期：** 2026-02-03  
**开发者：** AI Assistant  
**版本：** v2.0（Timeline 版本）

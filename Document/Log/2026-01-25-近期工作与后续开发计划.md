# Log - 2026-01-25：近期工作与后续开发计划

## 一、近期完成的工作内容

### 1. HTML Bundle 在时间线中以 iframe 正确显示

**问题**：上传 HTML Bundle（ZIP）成功，但在时间线中只显示为文件链接，未渲染为 iframe。

**原因**：后端 API 返回的 DriveFile 对象中未包含 `isHtmlBundle` 字段，前端无法判断该附件是否为 HTML Bundle。

**实现方式**：

- **后端**
  - `packages/backend/src/models/json-schema/drive-file.ts`：在 `packedDriveFileSchema` 中增加 `isHtmlBundle` 属性。
  - `packages/backend/src/core/entities/DriveFileEntityService.ts`：在 `pack()` 与 `packNullable()` 的返回值中加入 `isHtmlBundle: file.isHtmlBundle ?? false`。
- 前端 `MkMediaList.vue` 已通过 `media.isHtmlBundle` 渲染 `XHtmlBundle`（iframe），仅需 API 正确返回该字段即可生效。

**结果**：API 返回 `isHtmlBundle: true` 后，时间线中 HTML Bundle 能正确以 iframe 形式展示。

---

### 2. 直接粘贴 iframe 代码的嵌入功能

**需求**：支持用户粘贴完整 iframe 代码，作为单独附件类型，发帖前与时间线中均支持预览。

**实现方式**：

#### 后端

- **Note 模型**（`packages/backend/src/models/Note.ts`）
  - 新增 `iframeEmbeds` 字段（jsonb，默认 `[]`），结构：`{ src, width?, height?, title? }[]`。
- **API**
  - `packages/backend/src/server/api/endpoints/notes/create.ts`：请求体增加 `iframeEmbeds` 数组参数（最多 4 条，每项含 `src` 必填，`width`/`height`/`title` 可选）。
  - `packages/backend/src/core/NoteCreateService.ts`：Option 类型与 `fetchAndCreate`/`create` 支持 `iframeEmbeds`，写入 `MiNote.insert`。
  - `packages/backend/src/core/entities/NoteEntityService.ts`：pack 时返回 `iframeEmbeds`（有内容才返回）。
  - `packages/backend/src/models/json-schema/note.ts`：为 Note 的 packed 结构增加 `iframeEmbeds` 的 JSON Schema。

#### 前端

- **发帖与预览**
  - `MkIframeEmbedDialog.vue`：新增对话框，支持粘贴完整 iframe 标签或纯 URL，自动解析 `src`/`width`/`height`/`title`，并提供实时预览开关。
  - `MkPostForm.vue`：底部增加「添加 iframe 嵌入」按钮」；维护 `iframeEmbeds` 数组；发帖时随 `postData.iframeEmbeds` 提交；列表中展示已添加的 iframe 并可删除；`canPost` 将「存在 iframe 嵌入」视为有效内容；`clear()` 时清空 `iframeEmbeds`。
- **时间线展示**
  - `MkNoteIframeEmbed.vue`：单条 iframe 展示组件，默认占位「点击以显示」，点击后加载真实 iframe（带 sandbox 等安全属性）。
  - `MkNote.vue`、`MkNoteDetailed.vue`：在 Poll 与 URL 预览之间增加 `appearNote.iframeEmbeds` 的展示，循环渲染 `MkNoteIframeEmbed`。

#### 多语言

- `locales/zh-CN.yml`、`en-US.yml`、`ja-JP.yml`：增加 `attachIframeEmbed`、`iframeEmbedDescription`、`iframeCode`、`iframeSrc`、`iframeWidth`、`iframeHeight`、`iframeTitle`、`iframeParseError`、`iframeInvalidUrl`、`iframePreview`、`iframeEmbedAdded`、`removeIframeEmbed` 等文案。

**结果**：用户可通过发帖栏 iframe 按钮粘贴代码并预览，发帖后在时间线中以「点击加载」的 iframe 形式展示；允许任意域名（未做白名单限制）。

---

### 3. 数据库列缺失导致的 500 修复

**问题**：部署/重启后，接口 `api/i`、`api/notes/timeline`、`api/users/show` 等返回 500，控制台报错：`column note.iframeEmbeds does not exist`。

**原因**：Note 模型新增了 `iframeEmbeds` 字段，但项目未生成或未执行对应迁移，数据库中 `note` 表尚无该列。

**处理方式**：在 PostgreSQL 中手动执行（使用实际配置中的 DB 用户，示例为 `example-misskey-user`）：

```bash
docker compose -f compose.local-db.yml exec -T db psql -U example-misskey-user -d misskey -c \
  "ALTER TABLE note ADD COLUMN IF NOT EXISTS \"iframeEmbeds\" jsonb DEFAULT '[]'::jsonb;"
```

**结果**：列添加后，帖子、个人资料等接口恢复正常。**注意**：当前仅为临时修复，正式环境或迁移流程应使用下文「后续计划」中的迁移方案。

---

## 二、后续开发计划

### 1. 为 iframeEmbeds 编写正式数据库迁移（优先）

- 在 `packages/backend/migrations/` 下新增迁移文件，将 `note` 表增加 `iframeEmbeds` 列（jsonb，默认 `'[]'::jsonb`）。
- 使 `pnpm migrate` 能自动应用该变更，便于新环境部署与生产升级，避免再次手动执行 SQL。

### 2. HTML Bundle 与 Iframe 嵌入的巩固

- 对 HTML Bundle：确认子目录 `index.html`（如 `3d/index.html`）的检测与 `htmlBundlePath` 存储逻辑在各类 ZIP 结构下均正确；必要时补充边界用例测试。
- 对 iframe 嵌入：可考虑可选域名白名单、iframe 数量/长度限制复验；发帖前预览与时间线展示在移动端的表现可再优化。

### 3. 文档与可维护性

- 在 `Document/Function/` 下新增 **Iframe 嵌入功能** 的 Function Review，与现有 HTML Bundle 文档并列，便于后续接入或二次开发。
- 若后续有生产部署，在 `Document/Log` 或部署说明中记录「必须先执行迁移再启动」的步骤。

### 4. 其他可选方向

- 草稿与定时投稿：若产品需要，可考虑服务端草稿/定时帖是否支持携带 `iframeEmbeds`。
- 性能与安全：若 iframe 嵌入量增大，可评估对 Note 列表查询的影响；持续关注 iframe sandbox 与 CSP 的配置是否满足安全要求。

---

## 三、相关文件索引

| 类型       | 路径概要 |
|------------|----------|
| 后端模型   | `packages/backend/src/models/Note.ts`（iframeEmbeds） |
| 后端 API   | `packages/backend/src/server/api/endpoints/notes/create.ts` |
| 后端服务   | `packages/backend/src/core/NoteCreateService.ts`，`NoteEntityService.ts`，`DriveFileEntityService.ts` |
| 前端组件   | `packages/frontend/src/components/MkIframeEmbedDialog.vue`，`MkNoteIframeEmbed.vue`，`MkPostForm.vue`，`MkNote.vue`，`MkNoteDetailed.vue` |
| 多语言     | `misskey-develop/locales/zh-CN.yml`，`en-US.yml`，`ja-JP.yml` |
| 已有文档   | `Document/Function/` 下 HTML-Bundle 系列；`Document/Log/2025-01-25-启动说明与Linux新机清单.md`（含 drive_file 列、Vite 等排障） |

以上为近期完成工作与后续开发计划的汇总说明。

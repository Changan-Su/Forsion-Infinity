# Forsion Backend é›†æˆ - å®Œæ•´é…ç½®ç¤ºä¾‹
# 
# æ­¤æ–‡ä»¶å±•ç¤ºäº†å¦‚ä½•åœ¨ Misskey ä¸­å®Œæ•´é…ç½® Forsion Backend é›†æˆ
# åŒ…å«åç«¯å’Œå‰ç«¯çš„æ‰€æœ‰å¿…è¦é…ç½®

#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# 1. åç«¯é…ç½® (.config/default.yml)
#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# åœ¨ .config/default.yml æ–‡ä»¶æœ«å°¾æ·»åŠ ï¼š

forsion:
  enabled: true
  apiUrl: 'http://localhost:3001'

# å¼€å‘ç¯å¢ƒå®Œæ•´ç¤ºä¾‹ï¼š
# forsion:
#   enabled: true
#   apiUrl: 'http://localhost:3001'

# ç”Ÿäº§ç¯å¢ƒå®Œæ•´ç¤ºä¾‹ï¼š
# forsion:
#   enabled: true
#   apiUrl: 'https://api.forsion.com'

#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# 2. å‰ç«¯é…ç½® (packages/frontend/.env)
#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# å¤åˆ¶ packages/frontend/.env.example ä¸º .envï¼Œç„¶åä¿®æ”¹ï¼š

# å¼€å‘ç¯å¢ƒï¼š
VITE_FORSION_AUTH_URL=http://localhost:3001/auth
VITE_FORSION_API_URL=http://localhost:3001

# ç”Ÿäº§ç¯å¢ƒï¼š
# VITE_FORSION_AUTH_URL=https://api.forsion.com/auth
# VITE_FORSION_API_URL=https://api.forsion.com

#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# 3. Forsion Backend é…ç½® (Forsion Backend .env)
#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# åœ¨ Forsion Backend çš„ .env æ–‡ä»¶ä¸­éœ€è¦é…ç½®ï¼š

# JWT_SECRETï¼ˆç”¨äºç­¾åå’ŒéªŒè¯ JWTï¼ŒMisskey ä¸éœ€è¦æ­¤å¯†é’¥ï¼‰
JWT_SECRET=your-super-secret-jwt-key-keep-secure

# JWT è¿‡æœŸæ—¶é—´ï¼ˆé»˜è®¤7å¤©ï¼‰
JWT_EXPIRES_IN=7d

# CORS å…è®¸çš„æºï¼ˆå¿…é¡»åŒ…å« Misskey çš„ URLï¼‰
ALLOWED_ORIGINS=http://localhost:5173,http://localhost:3000,https://your-misskey.com

#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# 4. é…ç½®æ£€æŸ¥æ¸…å•
#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# âœ… Misskey Backend (.config/default.yml)
#    [ ] forsion.enabled = true
#    [ ] forsion.apiUrl æŒ‡å‘ Forsion Backend

# âœ… Misskey Frontend (packages/frontend/.env)
#    [ ] VITE_FORSION_AUTH_URL å·²è®¾ç½®
#    [ ] VITE_FORSION_API_URL å·²è®¾ç½®
#    [ ] URL ä¸åŒ…å«å°¾éƒ¨æ–œæ 

# âœ… Forsion Backend (.env)
#    [ ] JWT_SECRET å·²è®¾ç½®ï¼ˆç”¨äºç­¾å JWTï¼‰
#    [ ] ALLOWED_ORIGINS åŒ…å« Misskey çš„ URL
#    [ ] Forsion Backend æœåŠ¡æ­£åœ¨è¿è¡Œ

# âœ… æ•°æ®åº“
#    [ ] å·²è¿è¡Œæ•°æ®åº“è¿ç§»: pnpm migrate
#    [ ] forsion_user_mapping è¡¨å·²åˆ›å»º

# âœ… ç½‘ç»œè¿æ¥
#    [ ] Misskey Backend å¯ä»¥è®¿é—® Forsion Backend API
#    [ ] æ£€æŸ¥é˜²ç«å¢™è§„åˆ™

#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# 5. å¯åŠ¨æ­¥éª¤
#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# æ­¥éª¤1: é…ç½® Forsion Backend
cd /path/to/forsion-backend
# ç¼–è¾‘ .envï¼Œè®¾ç½® JWT_SECRET å’Œ ALLOWED_ORIGINS
npm run dev  # å¯åŠ¨ Forsion Backendï¼ˆç«¯å£ 3001ï¼‰

# æ­¥éª¤2: é…ç½® Misskey Backend
cd /path/to/misskey-develop
# ç¼–è¾‘ .config/default.ymlï¼Œæ·»åŠ  forsion é…ç½®
pnpm compile-config  # ç¼–è¯‘é…ç½®
pnpm migrate         # è¿è¡Œæ•°æ®åº“è¿ç§»
pnpm build           # æ„å»ºåç«¯
pnpm start           # å¯åŠ¨ Misskey Backendï¼ˆç«¯å£ 3000ï¼‰

# æ­¥éª¤3: é…ç½® Misskey Frontend
cd /path/to/misskey-develop/packages/frontend
# å¤åˆ¶ .env.example ä¸º .env
# ç¼–è¾‘ .envï¼Œè®¾ç½® VITE_FORSION_AUTH_URL å’Œ VITE_FORSION_API_URL
cd /path/to/misskey-develop
pnpm dev             # å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼ˆç«¯å£ 5173ï¼‰

# æ­¥éª¤4: æµ‹è¯•
# æ‰“å¼€æµè§ˆå™¨è®¿é—® http://localhost:5173
# åº”è¯¥èƒ½çœ‹åˆ° "Login with Forsion" æŒ‰é’®
# ç‚¹å‡»åè·³è½¬åˆ° http://localhost:3001/auth
# ç™»å½•åé‡å®šå‘å› Misskey

#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# 6. å¸¸è§é…ç½®åœºæ™¯
#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# åœºæ™¯1: æœ¬åœ°å¼€å‘ï¼ˆæ‰€æœ‰æœåŠ¡åœ¨ localhostï¼‰
# ------------------------------------------------
# Misskey Backend (.config/default.yml):
#   forsion:
#     enabled: true
#     apiUrl: 'http://localhost:3001'
#
# Misskey Frontend (.env):
#   VITE_FORSION_AUTH_URL=http://localhost:3001/auth
#   VITE_FORSION_API_URL=http://localhost:3001
#
# Forsion Backend (.env):
#   JWT_SECRET=dev-local-secret-123456789012345678901234567890
#   ALLOWED_ORIGINS=http://localhost:5173,http://localhost:3000

# åœºæ™¯2: ç”Ÿäº§ç¯å¢ƒï¼ˆæ‰€æœ‰æœåŠ¡ä½¿ç”¨åŸŸåï¼‰
# ------------------------------------------------
# Misskey Backend (.config/default.yml):
#   forsion:
#     enabled: true
#     apiUrl: 'https://api.forsion.com'
#
# Misskey Frontend (.env):
#   VITE_FORSION_AUTH_URL=https://api.forsion.com/auth
#   VITE_FORSION_API_URL=https://api.forsion.com
#
# Forsion Backend (.env):
#   JWT_SECRET=prod-strong-random-secret-DO-NOT-SHARE
#   ALLOWED_ORIGINS=https://misskey.example.com

# åœºæ™¯3: æ··åˆç¯å¢ƒï¼ˆForsion ç”Ÿäº§ï¼ŒMisskey æœ¬åœ°æµ‹è¯•ï¼‰
# ------------------------------------------------
# Misskey Backend (.config/default.yml):
#   forsion:
#     enabled: true
#     apiUrl: 'https://api.forsion.com'
#
# Misskey Frontend (.env):
#   VITE_FORSION_AUTH_URL=https://api.forsion.com/auth
#   VITE_FORSION_API_URL=https://api.forsion.com
#
# Forsion Backend (.env):
#   JWT_SECRET=prod-secret-from-forsion
#   ALLOWED_ORIGINS=http://localhost:5173,https://api.forsion.com

# åœºæ™¯4: ç¦ç”¨ Forsionï¼ˆå›é€€åˆ° Misskey åŸç”Ÿç™»å½•ï¼‰
# ------------------------------------------------
# Misskey Backend (.config/default.yml):
#   forsion:
#     enabled: false
#
# æ³¨æ„ï¼šç¦ç”¨å "Login with Forsion" æŒ‰é’®å°†ä¸æ˜¾ç¤º

#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# 7. å®‰å…¨å»ºè®®
#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# âš ï¸  JWT_SECRET å®‰å…¨ï¼ˆä»… Forsion Backendï¼‰
#     - ä½¿ç”¨å¼ºéšæœºå­—ç¬¦ä¸²ï¼ˆè‡³å°‘32å­—ç¬¦ï¼‰
#     - å¼€å‘å’Œç”Ÿäº§ä½¿ç”¨ä¸åŒçš„å¯†é’¥
#     - ä¸è¦æäº¤åˆ° Git ä»“åº“
#     - ä¸è¦å…±äº«ç»™å‰ç«¯æˆ–å…¶ä»–æœåŠ¡
#     - å®šæœŸè½®æ¢å¯†é’¥ï¼ˆéœ€è¦è®©æ‰€æœ‰ç”¨æˆ·é‡æ–°ç™»å½•ï¼‰

# âš ï¸  Token éªŒè¯æœºåˆ¶
#     - Misskey Backend é€šè¿‡è°ƒç”¨ Forsion Backend API éªŒè¯ token
#     - æ— éœ€åœ¨ Misskey Backend é…ç½® JWT_SECRET
#     - ç¡®ä¿ Misskey Backend å’Œ Forsion Backend ä¹‹é—´ç½‘ç»œç•…é€š

# âš ï¸  HTTPS è¦æ±‚
#     - ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ HTTPS
#     - JWT token åŒ…å«æ•æ„Ÿç”¨æˆ·ä¿¡æ¯
#     - ä½¿ç”¨ HTTP ä¼šå¯¼è‡´ token è¢«çªƒå–

# âš ï¸  CORS é…ç½®
#     - åªå…è®¸ä¿¡ä»»çš„åŸŸå
#     - ä¸è¦ä½¿ç”¨é€šé…ç¬¦ * 
#     - æ£€æŸ¥æ‹¼å†™é”™è¯¯ï¼ˆhttp vs httpsï¼‰

# âš ï¸  ç¯å¢ƒå˜é‡
#     - ä½¿ç”¨ .env æ–‡ä»¶ï¼ˆä¸æäº¤åˆ° Gitï¼‰
#     - ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–å¯†é’¥ç®¡ç†æœåŠ¡
#     - å®šæœŸå®¡è®¡é…ç½®æ–‡ä»¶

#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# 8. æ›´å¤šèµ„æº
#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# ğŸ“– è¯¦ç»†æ–‡æ¡£
#    - ./FORSION_INTEGRATION.md - å®Œæ•´é›†æˆæŒ‡å—
#    - ./FORSION_INTEGRATION_TESTS.md - æµ‹è¯•è®¡åˆ’
#    - ./Document/Log/2026-02-04-Forsion-Backendç™»å½•ç³»ç»Ÿé›†æˆå®æ–½.md - å®æ–½è®°å½•

# ğŸ”§ Skill æ–‡æ¡£
#    - .cursor/skills/forsion-login-integration/SKILL.md
#    - .cursor/skills/forsion-login-integration/api-reference.md

# ğŸ’¡ Token éªŒè¯æµç¨‹è¯´æ˜
#    1. å‰ç«¯ä» Forsion Backend ç™»å½•è·å– JWT token
#    2. å‰ç«¯ä¿å­˜ token åˆ° localStorage
#    3. å‰ç«¯å‘é€è¯·æ±‚æ—¶åœ¨ Authorization header ä¸­æºå¸¦ token
#    4. Misskey Backend æ”¶åˆ° tokenï¼Œè°ƒç”¨ Forsion Backend çš„ /api/auth/me éªŒè¯
#    5. Forsion Backend éªŒè¯ token å¹¶è¿”å›ç”¨æˆ·ä¿¡æ¯
#    6. Misskey Backend æ ¹æ®ç”¨æˆ·ä¿¡æ¯åˆ›å»º/è·å– Misskey ç”¨æˆ·

# ğŸ” éªŒè¯é…ç½®
#    - æ£€æŸ¥ Forsion Backend æ—¥å¿—
#    - æ£€æŸ¥ Misskey Backend æ—¥å¿—
#    - ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·æŸ¥çœ‹ç½‘ç»œè¯·æ±‚
#    - æŸ¥çœ‹ localStorage ä¸­çš„ forsion_jwt_token

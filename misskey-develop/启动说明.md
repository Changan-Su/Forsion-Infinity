# Forsion-Infinity / Misskey 启动说明

本项目基于 Misskey（联邦社交平台），使用 **pnpm** 包管理，需 **Node.js 22.15.0**、**PostgreSQL**、**Redis**、**FFmpeg**。

---

## 一、环境准备

### 1. 安装 Node.js 与 pnpm

- **Node.js**：使用 22.15.0（见 `.node-version`）
- **pnpm**：项目指定 `pnpm@10.27.0`，可用 `corepack enable` 后自动匹配  
  ```bash
  corepack enable
  ```

### 2. 安装中间件（任选其一）

| 方式 | 说明 |
|------|------|
| **Docker Compose（推荐）** | 只起 Redis + PostgreSQL，本机跑 Misskey |
| **系统全局安装** | 本机安装 PostgreSQL、Redis、FFmpeg |
| **Dev Container** | 用 VS Code Dev Container，全部在容器内（Windows 建议用 WSL 克隆仓库） |

---

## 二、使用 Docker 仅跑数据库（推荐本地开发）

### 1. 创建配置与环境变量

在 **`misskey-develop`** 目录下执行：

```powershell
cd misskey-develop

# 复制 Docker 用环境变量（PostgreSQL 账号等）
copy .config\docker_example.env .config\docker.env

# 复制开发用配置并改为本地连接
copy .devcontainer\devcontainer.yml .config\default.yml
```

编辑 **`.config\default.yml`**：

1. 将 `db`、`redis` 的 `host` 改为 `localhost`（原为 `db` / `redis`，仅在 Docker 网络内可用）。
2. `db.user`、`db.pass` 必须与 **`.config\docker.env`** 里的 `POSTGRES_USER`、`POSTGRES_PASSWORD` 一致。  
   - 若直接使用 `docker_example.env` 复制的 `docker.env`，则为 `example-misskey-user` / `example-misskey-pass`。  
   - 若自行修改 `docker.env` 为 `postgres` / `postgres`，则 `default.yml` 里也用 `postgres` / `postgres`。

示例（与 `docker_example.env` 一致时）：

```yaml
db:
  host: localhost
  port: 5432
  db: misskey
  user: example-misskey-user
  pass: example-misskey-pass

redis:
  host: localhost
  port: 6379
```

### 2. 启动 Redis 与 PostgreSQL

```powershell
docker compose -f compose.local-db.yml up -d
```

### 3. 安装依赖、构建、迁移、启动

```powershell
# 若有 git submodule
git submodule update --init

# 安装依赖
pnpm install --frozen-lockfile

# 构建
pnpm build

# 数据库迁移（首次必须）
pnpm migrate

# 启动后端（生产式运行）
pnpm start
```

或 **开发模式**（热重载，前后端一起）：

```powershell
pnpm dev
```

浏览器访问：**http://localhost:3000**（端口以 `default.yml` 里 `port` 为准）。

---

## 三、仅使用已有数据库时

若 PostgreSQL、Redis 已在本机或远程跑好：

1. 复制配置：`copy .config\example.yml .config\default.yml`
2. 编辑 `default.yml`，填写实际的 `db`、`redis` 连接信息（host、port、user、pass 等）
3. 然后执行：`pnpm install` → `pnpm build` → `pnpm migrate` → `pnpm start` 或 `pnpm dev`

---

## 四、常用命令速查

| 命令 | 说明 |
|------|------|
| `pnpm dev` | 开发模式（watch + 前端 HMR，默认 http://localhost:3000） |
| `pnpm start` | 生产式启动后端 |
| `pnpm build` | 全量构建 |
| `pnpm migrate` | 执行数据库迁移 |
| `pnpm migrateandstart` | 先迁移再启动 |
| `pnpm cli` | 后端 CLI 工具 |

---

## 五、环境变量

- **`MISSKEY_CONFIG_YML`**：指定配置文件路径，替代 `default.yml`（如 `2nd.yml`）
- **`MISSKEY_WEBFINGER_USE_HTTP`**：设为 `true` 时 WebFinger 用 HTTP，仅用于本地联调，**勿在生产使用**

---

## 六、可能遇到的问题

1. **缺少 `default.yml`**：务必在 `.config\` 下准备好 `default.yml`（从 `example.yml` 或 `devcontainer.yml` 复制再改）。
2. **数据库连接失败**：检查 PostgreSQL、Redis 是否已启动，`default.yml` 中 host/port/user/pass 是否与 `docker.env` 或实际环境一致。
3. **端口占用**：修改 `default.yml` 里的 `port`（默认 3000）。
4. **Windows 路径**：若使用 WSL 或 Docker，注意路径与 `docker.env`、挂载卷的对应关系。

上述步骤完成后，即可正常启动项目。

# Forsion-Infinity / Misskey 启动说明

本项目基于 Misskey（联邦社交平台），使用 **pnpm** 包管理，需 **Node.js 22.15.0**、**PostgreSQL**、**Redis**、**FFmpeg**。

---

## 零、全新 Linux 服务端快速启动（推荐）

在新机上按顺序执行以下步骤即可跑起来。

### 1. 安装基础环境

| 依赖 | 说明 |
|------|------|
| **Node.js 22.15.0** | 见 `.node-version`，推荐用 [nvm](https://github.com/nvm-sh/nvm) 安装（apt 的 Node 版本低且无 corepack） |
| **pnpm** | 用 nvm 的 Node 22 时，`corepack enable` 后即用 `pnpm@10.27.0` |
| **Docker + Docker Compose** | 用于跑 Redis、PostgreSQL（若用 Docker 方案） |
| **FFmpeg** | 用于音视频处理，如 `apt install ffmpeg` / `dnf install ffmpeg` |
| **Git** | 用于拉代码、克隆 fluent-emojis |

**nvm + Node 22 示例：**

```bash
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash
# 新开终端或 source ~/.bashrc
nvm install 22.15.0 && nvm use 22.15.0
corepack enable
```

### 2. 克隆代码与 fluent-emojis

```bash
cd /path/to/Forsion-Infinity
# 若 misskey-develop 为独立 git 仓库，在 misskey-develop 内执行：git submodule update --init
# 否则（本仓库 git 根在 Forsion-Infinity）在 misskey-develop 内手动克隆：
cd misskey-develop && git clone https://github.com/misskey-dev/emojis.git fluent-emojis
```

### 3. 配置与启动数据库（Docker 仅跑 Redis + PostgreSQL）

```bash
cd misskey-develop

# 复制 Docker 环境变量与默认配置（与 docker_example.env 匹配，无需改 db/redis）
cp .config/docker_example.env .config/docker.env
cp .config/example.yml .config/default.yml
```

`example.yml` 已配置 `db` / `redis` 为 `localhost`，且与 `docker_example.env` 的账号一致，一般无需再改。若自定义过 `docker.env`，需同步修改 `default.yml` 中的 `db.user`、`db.pass`。

```bash
docker compose -f compose.local-db.yml up -d
```

### 4. 安装依赖、构建、迁移、启动

```bash
pnpm install --frozen-lockfile
pnpm build
pnpm migrate
pnpm start
```

或开发模式（热重载）：

```bash
pnpm dev
```

浏览器访问 **http://localhost:3000**（端口以 `default.yml` 中 `port` 为准）。

### 5. 常见问题

- **缺 `default.yml`**：确保 `.config/default.yml` 存在（从 `example.yml` 复制）。
- **数据库连不上**：确认 Docker 容器已起（`docker compose -f compose.local-db.yml ps`），且 `default.yml` 与 `docker.env` 的 host/port/user/pass 一致。
- **端口占用**：修改 `default.yml` 中的 `port`（默认 3000）。
- **fluent-emojis 404 / 构建报错缺 dist**：在 `misskey-develop` 内执行 `git submodule update --init`；若子模块未配置，则 `git clone https://github.com/misskey-dev/emojis.git fluent-emojis`。
- **pnpm / Node 版本不符**：用 nvm 安装 Node 22.15.0，再 `corepack enable`。

---

## 一、环境准备

### 1. 安装 Node.js 与 pnpm

- **Node.js**：使用 22.15.0（见 `.node-version`）
- **pnpm**：项目指定 `pnpm@10.27.0`，可用 `corepack enable` 后自动匹配  
  ```bash
  corepack enable
  ```

### 2. 安装中间件（任选其一）

| 方式 | 说明 |
|------|------|
| **Docker Compose（推荐）** | 只起 Redis + PostgreSQL，本机跑 Misskey |
| **系统全局安装** | 本机安装 PostgreSQL、Redis、FFmpeg |
| **Dev Container** | 用 VS Code Dev Container，全部在容器内（Windows 建议用 WSL 克隆仓库） |

---

## 二、使用 Docker 仅跑数据库（推荐本地开发）

### 1. 创建配置与环境变量

在 **`misskey-develop`** 目录下执行：

```powershell
cd misskey-develop

# 复制 Docker 用环境变量（PostgreSQL 账号等）
copy .config\docker_example.env .config\docker.env

# 复制开发用配置并改为本地连接
copy .devcontainer\devcontainer.yml .config\default.yml
```

编辑 **`.config\default.yml`**：

1. 将 `db`、`redis` 的 `host` 改为 `localhost`（原为 `db` / `redis`，仅在 Docker 网络内可用）。
2. `db.user`、`db.pass` 必须与 **`.config\docker.env`** 里的 `POSTGRES_USER`、`POSTGRES_PASSWORD` 一致。  
   - 若直接使用 `docker_example.env` 复制的 `docker.env`，则为 `example-misskey-user` / `example-misskey-pass`。  
   - 若自行修改 `docker.env` 为 `postgres` / `postgres`，则 `default.yml` 里也用 `postgres` / `postgres`。

示例（与 `docker_example.env` 一致时）：

```yaml
db:
  host: localhost
  port: 5432
  db: misskey
  user: example-misskey-user
  pass: example-misskey-pass

redis:
  host: localhost
  port: 6379
```

### 2. 启动 Redis 与 PostgreSQL

```powershell
docker compose -f compose.local-db.yml up -d
```

### 3. 安装依赖、构建、迁移、启动

```powershell
# 若有 git submodule
git submodule update --init

# 安装依赖
pnpm install --frozen-lockfile

# 构建
pnpm build

# 数据库迁移（首次必须）
pnpm migrate

# 启动后端（生产式运行）
pnpm start
```

或 **开发模式**（热重载，前后端一起）：

```powershell
pnpm dev
```

浏览器访问：**http://localhost:3000**（端口以 `default.yml` 里 `port` 为准）。

---

## 三、仅使用已有数据库时

若 PostgreSQL、Redis 已在本机或远程跑好：

1. 复制配置：`copy .config\example.yml .config\default.yml`
2. 编辑 `default.yml`，填写实际的 `db`、`redis` 连接信息（host、port、user、pass 等）
3. 然后执行：`pnpm install` → `pnpm build` → `pnpm migrate` → `pnpm start` 或 `pnpm dev`

---

## 四、常用命令速查

| 命令 | 说明 |
|------|------|
| `pnpm dev` | 开发模式（watch + 前端 HMR，默认 http://localhost:3000） |
| `pnpm start` | 生产式启动后端 |
| `pnpm build` | 全量构建 |
| `pnpm migrate` | 执行数据库迁移 |
| `pnpm migrateandstart` | 先迁移再启动 |
| `pnpm cli` | 后端 CLI 工具 |

---

## 五、环境变量

项目根目录提供 **`.env.example`** 与 **`.env`**：

- **`.env.example`**：模板，已纳入 git；**`.env`**：本地覆盖，已加入 `.gitignore`。复制 `cp .env.example .env` 后按需修改。
- 使用 **`pnpm start:env`** 启动时，会自动加载 `.env` 再执行 `pnpm start`（需 Node 20.6+）。亦可手动 `set -a && source .env && set +a && pnpm start`。

常用变量：

- **`PORT`**：监听端口。仅当配置里**未**设置 `port` 时生效；若 `default.yml` 有 `port: 3000`，则 `PORT` 被忽略。改端口可：① 编辑 `default.yml` 的 `port`；或 ② 删掉/注释 `port`，在 `.env` 中写 `PORT=3001` 后用 `pnpm start:env`。
- **`MISSKEY_CONFIG_YML`**：指定配置文件路径，替代 `default.yml`（如 `2nd.yml`）
- **`MISSKEY_WEBFINGER_USE_HTTP`**：设为 `true` 时 WebFinger 用 HTTP，仅用于本地联调，**勿在生产使用**

---

## 六、可能遇到的问题

1. **缺少 `default.yml`**：务必在 `.config\` 下准备好 `default.yml`（从 `example.yml` 或 `devcontainer.yml` 复制再改）。
2. **数据库连接失败**：检查 PostgreSQL、Redis 是否已启动，`default.yml` 中 host/port/user/pass 是否与 `docker.env` 或实际环境一致。
3. **端口占用**：修改 `default.yml` 里的 `port`（默认 3000）。
4. **Windows 路径**：若使用 WSL 或 Docker，注意路径与 `docker.env`、挂载卷的对应关系。

上述步骤完成后，即可正常启动项目。
